---
description: Clean Architecture layer boundaries and dependencies for internal packages
globs: internal/**/*.go
alwaysApply: false
---

# Clean Architecture

Dependency flow: `cmd` → `delivery` → `services` → `domain`; `repository` → `domain`; `adapters` → `domain`. Only `cmd` instantiates repos and adapters (e.g. external-service clients).

- **domain** (`internal/domain`): Entities (e.g. `Event`, `Session`) and interfaces (`EventRepository`, `EventService`, `SessionizeFetcher`). No imports from `internal/services`, `internal/repository`, `internal/delivery`, or `internal/adapters`. Only stdlib (e.g. `context`, `time`) allowed.

- **services** (`internal/services`): Business logic. Depends only on `domain`. Receives repository interfaces, optional external-service ports (e.g. `SessionizeFetcher`), and optional timeout via constructor. Wrap errors with `fmt.Errorf(..., %w, err)`.

- **repository/postgres** (`internal/repository/postgres`): Implements domain repository interfaces. Uses `database/sql` and **raw SQL only** — no ORM. Unexported struct (e.g. `eventRepository`), constructor returns `domain.XxxRepository`.

- **external service adapters** (`internal/adapters/<name>`, e.g. `internal/adapters/sessionize`): Implements domain ports for **external services** (APIs, etc.). Unexported struct, constructor returns `domain.XxxFetcher` (or similar). Service receives the interface from domain; only `cmd` instantiates the concrete client.

- **email** (`internal/adapters/email`, `internal/services/email.go`): **Mailer** (domain port) is implemented in `internal/adapters/email` (SES + noop). **EmailTemplateRenderer** (domain port) is implemented there too: it loads templates from `internal/adapters/email/templates/` (embedded via `//go:embed templates/*`). Naming: for a template named `welcome`, files are `welcome_subject.txt`, `welcome.html`, `welcome.txt` (Go template syntax, e.g. `{{.FirstName}}`). The **EmailService** in `internal/services/email.go` depends only on `domain.Mailer` and `domain.EmailTemplateRenderer`; it calls `renderer.Render(templateName, data)` then `mailer.Send(...)`. Config (SES, from address) is loaded from env in `config` and passed into the adapter from `cmd`. See [email.mdc](email.mdc) and the add-email skill.

- **delivery/http** (`internal/delivery/http`): HTTP handlers and router. Depends on service via domain interfaces (e.g. `domain.EventService`). Uses `http.ServeMux`, `r.PathValue("param")` for path params. For JSON request bodies use **request DTOs** (e.g. `CreateEventRequest`) that expose only the fields the API accepts; decode with `DisallowUnknownFields()` and validate in the handler; do not decode directly into domain entities. Document handlers with swaggo comments. Request logging and 5xx error logging: see [logging.mdc](logging.mdc).

- **cmd** (`cmd/api`): Wire dependencies: DB → repos; instantiate clients (e.g. Sessionize); service (repos + client + timeout) → controller → `NewRouter(controller)`. Logger creation and wiring: see [logging.mdc](logging.mdc).

Reference: @internal/repository/postgres/event_repo.go @internal/services/manage_schedule.go @internal/delivery/http/controllers/schedule_controller.go @internal/adapters/sessionize/client.go @internal/adapters/email/mailer.go @internal/adapters/email/template_renderer.go @internal/services/email.go @internal/domain/email.go
